name: Update Transcripts Index

on:
  schedule:
    - cron: '0 11 * * *'
  
  workflow_dispatch:

jobs:
  update-transcripts:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Fetch from Google Apps Script
        run: |
          echo "üì• –ó–∞–≥—Ä—É–∂–∞—é –∏–Ω–¥–µ–∫—Å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–æ–∫..."
          curl -s "${{ secrets.GOOGLE_APPS_SCRIPT_URL }}" -o transcriptions-index.json
          
          echo "üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:"
          ls -lh transcriptions-index.json
          
          echo "üìã –ü–û–õ–ù–û–ï –°–û–î–ï–†–ñ–ò–ú–û–ï:"
          cat transcriptions-index.json
          echo ""
      
      - name: Validate JSON
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é JSON..."
          if python3 -m json.tool transcriptions-index.json > /dev/null 2>&1; then
            echo "‚úÖ JSON –≤–∞–ª–∏–¥–µ–Ω"
            EPISODES=$(python3 -c "import json; data=json.load(open('transcriptions-index.json')); print(len(data))")
            echo "   –í—Å–µ–≥–æ —ç–ø–∏–∑–æ–¥–æ–≤: $EPISODES"
          else
            echo "‚ùå JSON –Ω–µ–≤–∞–ª–∏–¥–µ–Ω!"
            echo "–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:"
            python3 -m json.tool transcriptions-index.json 2>&1 || true
            exit 1
          fi
      
      - name: Commit if changed
        if: success()
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          if git diff --quiet transcriptions-index.json 2>/dev/null; then
            echo "‚ÑπÔ∏è –§–∞–π–ª –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è"
          else
            echo "‚úÖ –ö–æ–º–º–∏—Ç—é –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
            git add transcriptions-index.json
            git commit -m "ü§ñ Auto-update transcripts from Google Drive"
            git push origin main
            echo "‚úÖ –ó–∞–ø—É—à–µ–Ω–æ –Ω–∞ main"
          fi
