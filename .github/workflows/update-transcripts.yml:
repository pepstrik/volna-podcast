name: Update Transcripts Index

on:
  schedule:
    - cron: '0 10 * * *'
  
  workflow_dispatch:

jobs:
  update-transcripts:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Debug - Check Secret
        run: |
          if [ -z "${{ secrets.GOOGLE_APPS_SCRIPT_URL }}" ]; then
            echo "‚ùå –û–®–ò–ë–ö–ê: Secret GOOGLE_APPS_SCRIPT_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
            exit 1
          else
            echo "‚úÖ Secret —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            echo "URL (–ø–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤): ${{ secrets.GOOGLE_APPS_SCRIPT_URL }}" | head -c 50
            echo "..."
          fi
      
      - name: Fetch transcripts index from Google Apps Script
        run: |
          echo "üì• –ó–∞–≥—Ä—É–∂–∞—é –∏–Ω–¥–µ–∫—Å —Å Google Apps Script..."
          curl -v "${{ secrets.GOOGLE_APPS_SCRIPT_URL }}" > transcriptions-index.json 2>&1
          
          echo ""
          echo "üìä –ü—Ä–æ–≤–µ—Ä—è—é —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞..."
          if [ -f transcriptions-index.json ]; then
            SIZE=$(wc -c < transcriptions-index.json)
            echo "‚úÖ –§–∞–π–ª —Å–æ–∑–¥–∞–Ω, —Ä–∞–∑–º–µ—Ä: $SIZE –±–∞–π—Ç"
            
            echo ""
            echo "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ (–ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤):"
            head -c 500 transcriptions-index.json
            echo ""
          else
            echo "‚ùå –§–∞–π–ª –Ω–µ —Å–æ–∑–¥–∞–Ω!"
            exit 1
          fi
      
      - name: Validate JSON
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é JSON..."
          if python3 -m json.tool transcriptions-index.json > /dev/null; then
            echo "‚úÖ JSON –≤–∞–ª–∏–¥–µ–Ω"
            echo "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ø–∏–∑–æ–¥–æ–≤:"
            python3 -c "import json; data = json.load(open('transcriptions-index.json')); print(f'  –í—Å–µ–≥–æ: {len(data)}')"
          else
            echo "‚ùå JSON –Ω–µ–≤–∞–ª–∏–¥–µ–Ω!"
            exit 1
          fi
      
      - name: Check if file changed
        id: check_changes
        run: |
          if git diff --quiet transcriptions-index.json 2>/dev/null; then
            echo "‚ÑπÔ∏è –§–∞–π–ª –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ –§–∞–π–ª –∏–∑–º–µ–Ω–∏–ª—Å—è"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add transcriptions-index.json
          git commit -m "ü§ñ Auto-update transcripts index from Google Drive"
          git push
          echo "‚úÖ –§–∞–π–ª –∑–∞–ø—É—à–µ–Ω –Ω–∞ GitHub"
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          echo "‚úÖ –§–∞–π–ª –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –Ω–∞ GitHub Pages"
